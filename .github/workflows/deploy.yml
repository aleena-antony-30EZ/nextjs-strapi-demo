name: Deploy to K3s

# Trigger workflow on push to main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_USER: ${{ secrets.DOCKER_USER }}
      DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

    steps:
      # Step 1: Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 3: Log in to Docker Hub
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # Step 4: Build & push Backend Docker image (Strapi)
      - name: Build & Push Backend
        run: |
          echo "Building backend Docker image..."
          docker build -t ${{ secrets.DOCKER_USER }}/strapi:latest backend/
          docker push ${{ secrets.DOCKER_USER }}/strapi:latest

      # Step 5: Build & push Frontend Docker image (Next.js)
      - name: Build & Push Frontend
        run: |
          echo "Building frontend Docker image..."
          docker build -t ${{ secrets.DOCKER_USER }}/nextjs:latest frontend/
          docker push ${{ secrets.DOCKER_USER }}/nextjs:latest

      # Step 6: SSH into K3s server and deploy manifests
      - name: Deploy to K3s via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_IP }}
          username: deploy
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Pulling latest Docker images..."
            docker pull ${{ secrets.DOCKER_USER }}/strapi:latest
            docker pull ${{ secrets.DOCKER_USER }}/nextjs:latest

            echo "Applying Kubernetes manifests..."
            kubectl apply -f ~/nextjs-corporate-starter/k8s/

            echo "Deployment completed!"

